<!DOCTYPE html>
<html lang="vi" data-theme="dark" style="--fs:16px">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HandSpeak AI</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="theme-color" content="#0f1115"/>

  <style>
    :root{--bg:#0f1115;--panel:#151923;--panel-2:#0a121c;--ink:#e6e9ef;--muted:#9aa5b1;--acc:#36d399;--ring:#2c3342;--danger:#ff6b6b}
    [data-theme=light]{--bg:#f6f8fb;--panel:#fff;--panel-2:#eef3fb;--ink:#0b1220;--muted:#576072;--acc:#0fb981;--ring:#d9e1ee;--danger:#e35050}
    [data-theme=hc]{--bg:#000;--panel:#000;--panel-2:#000;--ink:#fff;--muted:#ddd;--acc:#ff0;--ring:#fff}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:var(--fs)}
    a{color:var(--acc);text-decoration:none}
    main{max-width:1200px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:18px}
    header{display:flex;flex-direction:column;align-items:center;gap:8px}
    .brand{font-size:48px;font-style:italic;font-weight:900;margin:4px 0;text-align:center;font-family:Georgia,'Times New Roman',serif}
    nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    nav button{background:#1d2330;border:1px solid var(--ring);color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    [data-theme=light] nav button{background:#eef3fb}
    nav button.active{border-color:var(--acc);box-shadow:0 0 0 1px var(--acc) inset}
    .panel{background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:16px}
    h2{margin:0 0 8px}
    .hint{color:var(--muted);font-size:.9em}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.stretch>*{flex:1 1 auto}
    .ctrl,select,input,button{background:#1d2330;border:1px solid var(--ring);color:var(--ink);padding:8px 12px;border-radius:8px}
    [data-theme=light] select,[data-theme=light] input,[data-theme=light] button{background:#eef3fb}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:980px){.two{grid-template-columns:1fr}}
    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#394050;transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:3px;background:#fff;transition:.2s;border-radius:50%}
    .switch input:checked + .slider{background:var(--acc)} .switch input:checked + .slider:before{transform:translateX(20px)}
    #stage{position:relative;width:min(96vw,960px);aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;box-shadow:0 0 0 1px var(--ring) inset;margin:10px auto}
    #stage.mirror video,#stage.mirror canvas,#stage.mirror .ghost{transform:scaleX(-1)}
    #stage video,#stage canvas,.ghost{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #banner{position:absolute;left:12px;top:12px;padding:8px 12px;background:rgba(0,0,0,.6);border-radius:10px;color:#fff;font-weight:700}
    #faceTag{position:absolute;right:12px;top:12px;padding:8px 12px;background:rgba(0,0,0,.6);border-radius:10px;color:#fff;font-weight:700}
    #caption{margin-top:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--ring);background:var(--panel-2);font-weight:700;min-height:44px}
    .primary{background:var(--acc);color:#0b1712;border-color:#2b8d6b}
    .danger{background:var(--danger);color:#200;border-color:#c94141}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(88px,1fr));gap:10px}
    .cell{border:1px solid var(--ring);border-radius:10px;padding:16px;text-align:center;background:#101521;font-size:20px;font-weight:800;cursor:pointer;user-select:none}
    [data-theme=light] .cell{background:#fff}
    .log{border:1px solid var(--ring);background:#0a121c;color:var(--ink);border-radius:10px;padding:10px;height:180px;overflow:auto}
    [data-theme=light] .log{background:#eef3fb}
    footer{margin:10px auto 24px;text-align:center;color:var(--muted)}
    .range-row{display:flex;align-items:center;gap:4px}
    .range-row .range{flex:1 1 auto;width:100%}
    .range-row .val{min-width:44px;text-align:right}
    input[type=range].fillrange{-webkit-appearance:none;appearance:none;background:transparent;height:18px;cursor:pointer;border:none;padding:0;margin:0}
    input[type=range].fillrange::-webkit-slider-runnable-track{height:8px;border-radius:999px;background:linear-gradient(var(--acc),var(--acc)) 0/ var(--p,0%) 100% no-repeat,#2b3344;border:1px solid var(--ring)}
    [data-theme=light] input[type=range].fillrange::-webkit-slider-runnable-track{background:linear-gradient(var(--acc),var(--acc)) 0/ var(--p,0%) 100% no-repeat,#dfe7f5}
    input[type=range].fillrange::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;border:1px solid rgba(0,0,0,.2);margin-top:-5px;box-shadow:0 0 0 2px rgba(0,0,0,.06)}
    input[type=range].fillrange::-moz-range-track{height:8px;border-radius:999px;background:#2b3344;border:1px solid var(--ring)}
    [data-theme=light] input[type=range].fillrange::-moz-range-track{background:#dfe7f5}
    input[type=range].fillrange::-moz-range-progress{height:8px;border-radius:999px;background:var(--acc);border:1px solid var(--ring)}
    input[type=range].fillrange::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#fff;border:1px solid rgba(0,0,0,.2)}

    #cookieBox{position:fixed;left:16px;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:12px;display:none;gap:8px;align-items:center;z-index:99}
    #cookieBox .actions{margin-left:auto;display:flex;gap:8px}

    #ghost{pointer-events:none;opacity:.72;mix-blend-mode:screen}

    .hero-sub{
      margin-top:4px;font-size:18px;font-weight:700;text-align:center;
      font-family:"Times New Roman",Times,serif;color:var(--muted);opacity:0
    }
    .hero-zoom-in{animation:heroZoomIn 1.6s cubic-bezier(.2,.9,.25,1) forwards;transform-origin:center center}
    .hero-sub-show{animation:heroSubIn .9s ease-out forwards}
    .hero-sub-fade{animation:heroSubOut .35s ease-in forwards}
    @keyframes heroZoomIn{0%{transform:scale(.5);opacity:0}60%{transform:scale(1.08);opacity:1}100%{transform:scale(1);opacity:1}}
    @keyframes heroSubIn{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
    @keyframes heroSubOut{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-4px)}}

    .auth-bar{margin-top:8px;padding:10px;border-radius:12px;background:var(--panel-2);border:1px solid var(--ring);display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;width:100%}
    .auth-group{flex:1 1 260px;min-width:240px}
    .auth-label{font-size:.8em;color:var(--muted);margin-bottom:4px;display:block}
    .password-wrap{position:relative;display:flex;align-items:center}
    .password-wrap input{padding-right:32px}
    .icon-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:1rem;padding:0 4px}
    .small{font-size:.8em}
    #authTopBadge{position:fixed;left:10px;top:10px;z-index:100;background:rgba(10,18,28,.95);border-radius:999px;border:1px solid var(--ring);padding:4px 10px;font-size:.8em;display:none;align-items:center;gap:6px;box-shadow:0 10px 25px rgba(0,0,0,.7)}
    #authTopBadge button{padding:2px 6px;font-size:.75em}

    #progressChart{
      width:100%;max-width:520px;height:220px;border-radius:12px;
      border:1px solid var(--ring);background:#020617;display:block;margin:8px auto 4px
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
</head>
<body>

<div id="authTopBadge">
  <span id="authTopText">Ch·∫ø ƒë·ªô kh√°ch</span>
  <button id="authTopLogout" class="ctrl small">ƒêƒÉng xu·∫•t</button>
</div>

<div id="cookieBox" role="dialog" aria-live="polite">
  <div id="cookieMsg">Cho ph√©p l∆∞u Streak (ng√†y luy·ªán t·∫≠p) v√†o tr√¨nh duy·ªát?</div>
  <div class="actions">
    <button id="cookieYes" class="primary">Cho ph√©p</button>
    <button id="cookieNo">Kh√¥ng</button>
  </div>
</div>

<main>
  <header>
    <h1 class="brand hero-zoom-in" id="heroTitle">HandSpeak AI</h1>
    <p id="heroSubtitle" class="hero-sub"></p>

    <div class="auth-bar">
      <div class="auth-group">
        <label class="auth-label" id="authLblEmail">Gmail</label>
        <input id="authEmail" type="email" class="ctrl" placeholder="gmail@v√≠ d·ª•.com" />

        <label class="auth-label" id="authLblName" style="margin-top:6px;">T√™n ng∆∞·ªùi d√πng</label>
        <input id="authName" type="text" class="ctrl" placeholder="T√™n hi·ªÉn th·ªã" />

        <label class="auth-label" id="authLblPass" style="margin-top:6px;">M·∫≠t kh·∫©u (ch·ª©a ch·ªØ c√°i, s·ªë v√† k√Ω t·ª± @)</label>
        <div class="password-wrap">
          <input id="authPass" type="password" class="ctrl" placeholder="V√≠ d·ª•: Hs@2025" />
          <button type="button" id="togglePass" class="icon-btn" title="Hi·ªán/·∫©n m·∫≠t kh·∫©u">üëÅ</button>
        </div>
      </div>

      <div class="auth-group">
        <span class="auth-label" id="authLblAction">ƒêƒÉng k√Ω / ƒêƒÉng nh·∫≠p</span>
        <div class="row" style="gap:6px;margin-top:4px;">
          <button id="btnRegister" class="primary">ƒêƒÉng k√Ω</button>
          <button id="btnLogin">ƒêƒÉng nh·∫≠p</button>
          <button id="btnGuest" class="small">Ti·∫øp t·ª•c kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p</button>
        </div>

        <span class="auth-label" id="authLblOr" style="margin-top:6px;">Ho·∫∑c ƒëƒÉng nh·∫≠p b·∫±ng</span>
        <div class="row" style="gap:6px;margin-top:4px;">
          <button id="btnLoginFacebook" class="small">Facebook</button>
          <button id="btnLoginPhone" class="small">SƒêT (OTP)</button>
          <button id="btnLoginApple" class="small">Apple ID</button>
        </div>

        <div id="authStatus" class="hint" style="margin-top:6px;">
          Ch∆∞a ƒëƒÉng nh·∫≠p ‚Äì b·∫°n c√≥ th·ªÉ d√πng ch·∫ø ƒë·ªô Kh√°ch.
        </div>
      </div>
    </div>

    <div class="row stretch" id="topbar">
      <label class="ctrl" style="min-width:240px"><span id="t_lang">Ng√¥n ng·ªØ</span> /
        <select id="lang"><option value="vi" selected>Ti·∫øng Vi·ªát</option><option value="en">English</option></select>
      </label>

      <label class="ctrl" style="min-width:220px"><span id="t_theme">Ch·ªß ƒë·ªÅ</span>:
        <select id="theme">
          <option value="normal" selected>B√¨nh th∆∞·ªùng</option>
          <option value="light">S√°ng</option>
          <option value="dark">T·ªëi</option>
          <option value="hc">T∆∞∆°ng ph·∫£n cao</option>
        </select>
      </label>

      <label class="ctrl" style="flex:2 1 380px">
        <div class="range-row">
          <span id="t_font">C·ª° ch·ªØ</span>:
          <input id="fontStep" class="range fillrange" type="range" min="12" max="28" value="16"/>
          <span id="fontVal" class="val">16px</span>
        </div>
      </label>

      <div class="ctrl" id="streakBox">
        <span class="hint" id="streakHint">Ch∆∞a luy·ªán t·∫≠p</span>
        <span class="hint"> | </span>
        <b id="streakCount">Streak: 0</b>
        <button id="askCookie" class="primary" style="margin-left:8px">Cho ph√©p l∆∞u</button>
      </div>
    </div>

    <nav>
      <button data-tab="intro" class="active" id="tabBtnIntro">Gi·ªõi thi·ªáu</button>
      <button data-tab="learn" id="tabBtnLearn">H·ªçc &amp; Tra c·ª©u</button>
      <button data-tab="practice" id="tabBtnPractice">Th·ª±c h√†nh</button>
      <button data-tab="impact" id="tabBtnImpact">Bi·ªÉu ƒë·ªì &amp; √ù nghƒ©a</button>
      <button data-tab="contact" id="tabBtnContact">Li√™n h·ªá</button>
    </nav>
  </header>

  <section class="panel" id="tab-intro">
    <div class="two">
      <div>
        <h2 id="i1">1) Gi·ªõi thi·ªáu</h2>
        <p id="i2"><b>Handspeak</b> l√† m·ªôt d·ª± √°n c·ªông ƒë·ªìng h·ªó tr·ª£ ng∆∞·ªùi khi·∫øm th√≠nh giao ti·∫øp v√† gi√∫p m·ªçi ng∆∞·ªùi h·ªçc ng√¥n ng·ªØ k√Ω hi·ªáu.</p>
        <ul id="i3">
          <li>Nh·∫≠n d·∫°ng c·ª≠ ch·ªâ theo th·ªùi gian th·ª±c.</li>
          <li>C√°c c·ª≠ ch·ªâ ph·ªï bi·∫øn + b·∫£ng ch·ªØ c√°i &amp; s·ªë.</li>
          <li>H·ªó tr·ª£ Ti·∫øng Vi·ªát &amp; Ti·∫øng Anh. X·ª≠ l√Ω tr√™n thi·∫øt b·ªã.</li>
        </ul>
      </div>
      <div>
        <h3 style="text-align:center" id="i4">B·∫£ng ng√¥n ng·ªØ k√Ω hi·ªáu</h3>
        <img
          id="chartImg"
          style="width:100%;height:auto;border-radius:10px;border:1px solid var(--ring)"
          alt="B·∫£ng ng√¥n ng·ªØ k√Ω hi·ªáu"
          src="https://scontent.fvca1-4.fna.fbcdn.net/v/t39.30808-6/598558840_868448555728165_964472836478380615_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=127cfc&_nc_ohc=5dE5stdcfsQQ7kNvwGkxEJ6&_nc_oc=AdljctwdQSAb6IiJ0ktga8KB2g7_Opy7JHwbt6XB2GvXtT0sDkaxwgELFiA_xezfC05Nv8pfImPLps09Tzf8TEIA&_nc_zt=23&_nc_ht=scontent.fvca1-4.fna&_nc_gid=p4DZb9mX_WEZpcQOK4TyiQ&oh=00_AfmHOP3q06RPei54cXa9B6xwMYe82uxV2IYVUnDaf6uELA&oe=69445F6A"
        />
      </div>
    </div>
  </section>

  <section class="panel" id="tab-learn" hidden>
    <h2 id="l1">2) H·ªçc &amp; Tra c·ª©u</h2>
    <p class="hint" id="l2">B·∫•m v√†o √¥ ƒë·ªÉ nghe ph√°t √¢m k√Ω t·ª±.</p>
    <div class="grid" id="alphaGrid"></div>
  </section>

  <section class="panel" id="tab-practice" hidden>
    <h2 id="p1">3) Th·ª±c h√†nh v·ªõi camera</h2>

    <div id="stage">
      <video id="video" class="input_video" autoplay playsinline muted></video>
      <canvas id="canvas" class="output_canvas"></canvas>
      <canvas id="ghost" class="ghost"></canvas>
      <div id="banner">Ch∆∞a b·∫≠t camera</div>
      <div id="faceTag" aria-live="polite">üôÇ</div>
    </div>
    <div id="caption" aria-live="polite">‚Ä¶</div>

    <div class="row" id="controls">
      <button id="startCam" class="primary">B·∫≠t camera</button>
      <button id="stopCam">T·∫Øt camera</button>
      <button id="flipCam">L·∫≠t g∆∞∆°ng</button>

      <label class="ctrl">
        <span id="p2_label">Ch·∫ø ƒë·ªô</span>:
        <select id="mode">
          <option value="auto">T·ª± ƒë·ªông</option>
          <option value="actions" selected>Ch·ªâ h√†nh ƒë·ªông</option>
          <option value="alphabet">Ch·ªâ alphabet</option>
        </select>
      </label>

      <label class="switch" title="Ti·∫øt ki·ªám pin (h·∫° ph√¢n gi·∫£i, gi·∫£m t·∫£i)">
        <input type="checkbox" id="powerSave"/><span class="slider"></span>
      </label><span id="p2_powersave">Ti·∫øt ki·ªám pin</span>

      <button id="quickHelp">H∆∞·ªõng d·∫´n nhanh</button>

      <label class="switch">
        <input type="checkbox" id="toggle-audio" checked/><span class="slider"></span>
      </label><span id="p2_audio">B·∫≠t √¢m thanh</span>

      <button id="vol-dec">‚àí</button>
      <input type="range" id="vol" class="range fillrange" min="0" max="1" step="0.05" value="1">
      <button id="vol-inc">+</button>
      <span id="vol-val" class="val">100%</span>

      <input id="tutorSeq" class="ctrl" style="min-width:320px" placeholder="Nh·∫≠p chu·ªói k√Ω t·ª± (v√≠ d·ª•: HELLO)"/>
      <button id="tutorStart">B·∫Øt ƒë·∫ßu h∆∞·ªõng d·∫´n</button>
      <label class="switch" title="Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n ·∫£o">
        <input type="checkbox" id="ghostToggle" checked/><span class="slider"></span>
      </label><span id="p2_ghost">Hi·ªán h∆∞·ªõng d·∫´n ·∫£o</span>

      <label class="ctrl">
        <span id="voiceLbl">Gi·ªçng ƒë·ªçc</span>:
        <select id="voiceSelect"><option>ƒêang t·∫£i‚Ä¶</option></select>
        <button id="refreshVoice">‚Üª</button>
      </label>

      <button id="recStart">Ghi h√¨nh (kh√¥ng mic)</button>
      <button id="recStop" class="danger">D·ª´ng &amp; T·∫£i video</button>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="row">
        <label class="ctrl"><b id="alphaTitle">Alphabet:</b> <span id="alphaPred">‚Äî</span></label>
      </div>
      <div class="row">
        <label class="ctrl">
          <span id="p3_load">N·∫°p JSON alphabet</span>:
          <input id="alphaFile" type="file" accept=".json,.js"/>
        </label>
        <button id="alphaLoad">N·∫°p t·ªáp</button>
        <button id="alphaClear">X√≥a DB</button>
        <span class="hint" id="alphaInfo">Ch∆∞a n·∫°p DB</span>
      </div>
      <div class="row">
        <input id="ttsText" class="ctrl" style="min-width:320px" value="Xin ch√†o! ƒê√¢y l√† ki·ªÉm tra ti·∫øng n√≥i.">
        <button id="sayNow">ƒê·ªçc th·ª≠</button>
        <button id="stopSay">D·ª´ng</button>
      </div>
    </div>

    <div class="log" id="liveLog" aria-live="polite"></div>
  </section>

  <section class="panel" id="tab-impact" hidden>
    <h2 id="im1">4) Bi·ªÉu ƒë·ªì h·ªçc t·∫≠p &amp; √Ω nghƒ©a</h2>
    <p class="hint" id="progressHint">Bi·ªÉu ƒë·ªì ghi nh·∫≠n qu√° tr√¨nh luy·ªán t·∫≠p</p>
    <canvas id="progressChart" width="420" height="200"></canvas>

    <h3 style="margin-top:12px;" id="impactTitle2">√ù nghƒ©a &amp; t√°c ƒë·ªông</h3>
    <ul id="im2">
      <li>Thi·∫øt k·∫ø ti·∫øp c·∫≠n (t∆∞∆°ng ph·∫£n cao, c·ª° ch·ªØ, ph·ª• ƒë·ªÅ).</li>
      <li>Gi·∫£m r√†o c·∫£n k√Ω hi·ªáu ‚Üí l·ªùi n√≥i, h·ªçc c√≥ h∆∞·ªõng d·∫´n.</li>
      <li>X·ª≠ l√Ω tr√™n thi·∫øt b·ªã; kh√¥ng g·ª≠i m√°y ch·ªß.</li>
    </ul>
  </section>

  <section class="panel" id="tab-contact" hidden>
    <h2 id="c1">5) Li√™n h·ªá</h2>
    <div class="grid">
      <div class="cell">
        <h3 id="c2">üìß Gmail</h3>
        <a id="c2a" href="mailto:lyminhsin1106@gmail.com">lyminhsin1106@gmail.com</a>
      </div>
      <div class="cell">
        <h3 id="c3">üìù G√≥p √Ω</h3>
        <a id="c3a" target="_blank" rel="noopener" href="https://forms.gle/2xaCbZrDmuqT2B587">T·∫°i ƒë√¢y</a>
      </div>
      <div class="cell">
        <h3 id="c4">üìû ƒêi·ªán tho·∫°i</h3>
        <div><a href="tel:0943900802">0943900802</a> (Minh S·ªãn)</div>
        <div><a href="tel:0353143116">0353143116</a> (Minh Huy)</div>
      </div>
    </div>
  </section>
</main>

<footer>¬© <span id="cp">B·∫£n quy·ªÅn thu·ªôc v·ªÅ</span>: <b>MHS</b> ¬Æ</footer>

<script>
window.addEventListener('DOMContentLoaded', () => {
/* ==== I18N & helpers ==== */
const I18N={
  vi:{
    tabs:['Gi·ªõi thi·ªáu','H·ªçc & Tra c·ª©u','Th·ª±c h√†nh','Bi·ªÉu ƒë·ªì & √ù nghƒ©a','Li√™n h·ªá'],
    lang:'Ng√¥n ng·ªØ',theme:'Ch·ªß ƒë·ªÅ',font:'C·ª° ch·ªØ',
    intro_h:'1) Gi·ªõi thi·ªáu',
    intro_p:'<b>Handspeak</b> l√† m·ªôt d·ª± √°n c·ªông ƒë·ªìng h·ªó tr·ª£ ng∆∞·ªùi khi·∫øm th√≠nh giao ti·∫øp v√† gi√∫p m·ªçi ng∆∞·ªùi h·ªçc ng√¥n ng·ªØ k√Ω hi·ªáu.',
    intro_list:['Nh·∫≠n d·∫°ng c·ª≠ ch·ªâ theo th·ªùi gian th·ª±c.','C√°c c·ª≠ ch·ªâ ph·ªï bi·∫øn + b·∫£ng ch·ªØ c√°i & s·ªë.','H·ªó tr·ª£ Ti·∫øng Vi·ªát & Ti·∫øng Anh. X·ª≠ l√Ω tr√™n thi·∫øt b·ªã.'],
    board:'B·∫£ng ng√¥n ng·ªØ k√Ω hi·ªáu',
    learn_h:'2) H·ªçc & Tra c·ª©u',learn_hint:'B·∫•m v√†o √¥ ƒë·ªÉ nghe ph√°t √¢m k√Ω t·ª±.',
    practice_h:'3) Th·ª±c h√†nh v·ªõi camera',
    mode:'Ch·∫ø ƒë·ªô',powersave:'Ti·∫øt ki·ªám pin',audio:'B·∫≠t √¢m thanh',ghost:'Hi·ªán h∆∞·ªõng d·∫´n ·∫£o',load_json:'N·∫°p JSON alphabet',
    contact_h:'5) Li√™n h·ªá',email:'üìß Gmail',feedback:'üìù G√≥p √Ω',feedback_link:'T·∫°i ƒë√¢y',phone:'üìû ƒêi·ªán tho·∫°i',
    impact_h:'4) Bi·ªÉu ƒë·ªì h·ªçc t·∫≠p & t√°c ƒë·ªông',
    impact_list:['Thi·∫øt k·∫ø ti·∫øp c·∫≠n (t∆∞∆°ng ph·∫£n cao, c·ª° ch·ªØ, ph·ª• ƒë·ªÅ).','Gi·∫£m r√†o c·∫£n k√Ω hi·ªáu ‚Üí l·ªùi n√≥i, h·ªçc c√≥ h∆∞·ªõng d·∫´n.','X·ª≠ l√Ω tr√™n thi·∫øt b·ªã; kh√¥ng g·ª≠i m√°y ch·ªß.'],
    copyright:'B·∫£n quy·ªÅn thu·ªôc v·ªÅ',
    quick:`‚Ä¢ B·∫≠t camera tr√™n HTTPS/localhost.\n‚Ä¢ Gi·ªØ tay r√µ trong khung h√¨nh; d√πng ‚ÄúL·∫≠t g∆∞∆°ng‚Äù cho camera tr∆∞·ªõc.`,
    tutor_prompt:(ch)=>`Th·ª±c hi·ªán k√Ω hi·ªáu: ${ch}`,
    phrases:{WAVE:'Xin ch√†o!',OPEN_PALM:'Ch√†o b·∫°n!',STOP:'D·ª´ng l·∫°i!',THUMBS_UP:'L√†m t·ªët l·∫Øm!',THUMBS_DOWN:'Kh√¥ng th√≠ch!',OK:'OK!',VICTORY:'Tuy·ªát v·ªùi!',FIST:'Xin l·ªói!',POINT:'·ªû kia!',THANKS:'C·∫£m ∆°n!'},
    voice:'Gi·ªçng ƒë·ªçc',
    progress_title:'Bi·ªÉu ƒë·ªì ghi nh·∫≠n qu√° tr√¨nh luy·ªán t·∫≠p',
    theme_normal:'B√¨nh th∆∞·ªùng', theme_light:'S√°ng', theme_dark:'T·ªëi', theme_hc:'T∆∞∆°ng ph·∫£n cao',
    mode_auto:'T·ª± ƒë·ªông', mode_actions:'Ch·ªâ h√†nh ƒë·ªông', mode_alphabet:'Ch·ªâ alphabet',
    ask_cookie:'Cho ph√©p l∆∞u',

    // ‚úÖ Practice buttons/messages
    start_cam:'B·∫≠t camera',
    stop_cam:'T·∫Øt camera',
    mirror:'L·∫≠t g∆∞∆°ng',
    tutor_start:'B·∫Øt ƒë·∫ßu h∆∞·ªõng d·∫´n',
    record_start:'Ghi h√¨nh (kh√¥ng mic)',
    record_stop:'D·ª´ng & T·∫£i video',
    say_now:'ƒê·ªçc th·ª≠',
    say_stop:'D·ª´ng',
    alpha_load_btn:'N·∫°p t·ªáp',
    alpha_clear_btn:'X√≥a DB',
    select_json_first:'Ch·ªçn t·ªáp JSON tr∆∞·ªõc',
    loaded_db:'ƒê√£ n·∫°p DB',
    invalid_json:'T·ªáp JSON kh√¥ng h·ª£p l·ªá',
    db_cleared:'ƒê√£ x√≥a DB',
    camera_stopped:'ƒê√£ t·∫Øt camera',
    requesting_camera:'ƒêang xin quy·ªÅn camera‚Ä¶',
    ready_hand:'S·∫µn s√†ng ‚Äî gi∆° tay üëã',
    browser_not_supported:'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£',
    mediapipe_not_loaded:'Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán Mediapipe.',
    enter_seq:'Nh·∫≠p chu·ªói ch·ªØ/s·ªë'
  },
  en:{
    tabs:['Intro','Learn & Reference','Practice','Progress & impact','Contact'],
    lang:'Language',theme:'Theme',font:'Font size',
    intro_h:'1) Introduction',
    intro_p:'<b>Handspeak</b> helps Deaf/HoH users communicate and learn sign language.',
    intro_list:['Real-time gesture recognition.','Popular gestures + letters & digits.','Bilingual (VI/EN). On-device processing.'],
    board:'Sign language chart',
    learn_h:'2) Learn & Reference',learn_hint:'Tap a tile to hear pronunciation.',
    practice_h:'3) Practice with camera',
    mode:'Mode',powersave:'Power save',audio:'Enable audio',ghost:'Show ghost tutor',load_json:'Load alphabet JSON',
    contact_h:'5) Contact',email:'üìß Email',feedback:'üìù Feedback',feedback_link:'Here',phone:'üìû Phone',
    impact_h:'4) Progress & impact',
    impact_list:['Accessible design (high contrast, font sizing, captions).','Bridges sign ‚Üí speech with guided practice.','On-device; no server upload.'],
    copyright:'Copyright',
    quick:`‚Ä¢ Use camera over HTTPS/localhost.\n‚Ä¢ Keep hands in frame; use ‚ÄúMirror‚Äù for front camera.`,
    tutor_prompt:(ch)=>`Show sign for: ${ch}`,
    phrases:{WAVE:'Hello!',OPEN_PALM:'Hi there!',STOP:'Stop!',THUMBS_UP:'Great job!',THUMBS_DOWN:'Dislike!',OK:'OK!',VICTORY:'Awesome!',FIST:'Sorry!',POINT:'Over there!',THANKS:'Thank you!'},
    voice:'Voice',
    progress_title:'Training progress chart',
    theme_normal:'Normal', theme_light:'Light', theme_dark:'Dark', theme_hc:'High contrast',
    mode_auto:'Auto', mode_actions:'Actions only', mode_alphabet:'Alphabet only',
    ask_cookie:'Allow saving',

    // ‚úÖ Practice buttons/messages
    start_cam:'Start camera',
    stop_cam:'Stop camera',
    mirror:'Mirror',
    tutor_start:'Start tutor',
    record_start:'Record (no mic)',
    record_stop:'Stop & Download video',
    say_now:'Speak test',
    say_stop:'Stop',
    alpha_load_btn:'Load file',
    alpha_clear_btn:'Clear DB',
    select_json_first:'Select JSON first',
    loaded_db:'Loaded DB',
    invalid_json:'Invalid JSON',
    db_cleared:'DB cleared',
    camera_stopped:'Camera stopped',
    requesting_camera:'Requesting camera‚Ä¶',
    ready_hand:'Ready ‚Äî show your hand üëã',
    browser_not_supported:'Browser not supported',
    mediapipe_not_loaded:'Mediapipe not loaded.',
    enter_seq:'Enter letters/numbers'
  }
};
const $=id=>document.getElementById(id);

function applyI18N(lang){
  const t=I18N[lang];
  $('tabBtnIntro').textContent=t.tabs[0];
  $('tabBtnLearn').textContent=t.tabs[1];
  $('tabBtnPractice').textContent=t.tabs[2];
  $('tabBtnImpact').textContent=t.tabs[3];
  $('tabBtnContact').textContent=t.tabs[4];

  $('t_lang').textContent=t.lang;
  $('t_theme').textContent=t.theme;
  $('t_font').textContent=t.font;

  $('i1').textContent=t.intro_h;
  $('i2').innerHTML=t.intro_p;
  $('i3').innerHTML=t.intro_list.map(x=>`<li>${x}</li>`).join('');
  $('i4').textContent=t.board;

  $('l1').textContent=t.learn_h;
  $('l2').textContent=t.learn_hint;

  $('p1').textContent=t.practice_h;
  $('p2_label').textContent=t.mode;
  $('p2_powersave').textContent=t.powersave;
  $('p2_audio').textContent=t.audio;
  $('p2_ghost').textContent=t.ghost;
  $('p3_load').textContent=t.load_json;

  $('cp').textContent=t.copyright;
  $('voiceLbl').textContent=t.voice;

  $('im1').textContent=t.impact_h;
  $('im2').innerHTML=t.impact_list.map(x=>`<li>${x}</li>`).join('');

  $('c1').textContent=t.contact_h;
  $('c2').textContent=t.email;
  $('c3').textContent=t.feedback;
  $('c3a').textContent=t.feedback_link;
  $('c4').textContent=t.phone;

  $('progressHint').textContent = t.progress_title;

  const th=$('theme');
  th.options[0].textContent=t.theme_normal;
  th.options[1].textContent=t.theme_light;
  th.options[2].textContent=t.theme_dark;
  th.options[3].textContent=t.theme_hc;

  const md=$('mode');
  md.options[0].textContent=t.mode_auto;
  md.options[1].textContent=t.mode_actions;
  md.options[2].textContent=t.mode_alphabet;

  $('askCookie').textContent=t.ask_cookie;

  // ‚úÖ Practice buttons (VI/EN)
  $('startCam').textContent=t.start_cam;
  $('stopCam').textContent=t.stop_cam;
  $('flipCam').textContent=t.mirror;
  $('tutorStart').textContent=t.tutor_start;
  $('recStart').textContent=t.record_start;
  $('recStop').textContent=t.record_stop;
  $('sayNow').textContent=t.say_now;
  $('stopSay').textContent=t.say_stop;
  $('alphaLoad').textContent=t.alpha_load_btn;
  $('alphaClear').textContent=t.alpha_clear_btn;

  $('quickHelp').textContent=(lang==='en'?'Quick guide':'H∆∞·ªõng d·∫´n nhanh');
}

/* Tabs */
const tabs={intro:'tab-intro',learn:'tab-learn',practice:'tab-practice',impact:'tab-impact',contact:'tab-contact'};
document.querySelectorAll('nav button').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('nav button').forEach(x=>x.classList.toggle('active',x===b));
  for(const k in tabs) $(tabs[k]).hidden=(k!==b.dataset.tab);
});

/* Theme + font */
function setTheme(v){
  if(v==='light')document.documentElement.setAttribute('data-theme','light');
  else if(v==='dark')document.documentElement.setAttribute('data-theme','dark');
  else if(v==='hc')document.documentElement.setAttribute('data-theme','hc');
  else{
    const d=matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';
    document.documentElement.setAttribute('data-theme',d);
  }
}
$('theme').onchange=e=>{setTheme(e.target.value);localStorage.setItem('hs_theme',e.target.value)};
(function(){const t=localStorage.getItem('hs_theme')||'normal';$('theme').value=t;setTheme(t)})();
$('fontStep').oninput=e=>{document.documentElement.style.setProperty('--fs',e.target.value+'px');$('fontVal').textContent=e.target.value+'px';localStorage.setItem('hs_fs',e.target.value)};
(function(){const v=localStorage.getItem('hs_fs')||'16';$('fontStep').value=v;$('fontVal').textContent=v+'px';document.documentElement.style.setProperty('--fs',v+'px')})();
(function(el){if(!el)return;const setP=()=>{const min=+el.min||0,max=+el.max||100,val=+el.value||0;el.style.setProperty('--p',((val-min)*100/(max-min))+'%')};el.addEventListener('input',setP);setP()})($('fontStep'));
(function(el){if(!el)return;const setP=()=>{const min=+el.min||0,max=+el.max||1,val=+el.value||0;el.style.setProperty('--p',((val-min)*100/(max-min))+'%')};el.addEventListener('input',setP);setP()})($('vol'));

/* Consent & streak */
function getConsent(){return localStorage.getItem('hs_consent')==='yes'}
function setConsent(v){localStorage.setItem('hs_consent',v?'yes':'no');updateStreakUI();hideCookieBox()}
function showCookieBox(){ $('cookieBox').style.display='flex' }
function hideCookieBox(){ $('cookieBox').style.display='none' }
$('cookieYes').onclick=()=>setConsent(true);
$('cookieNo').onclick=()=>setConsent(false);
$('askCookie').onclick=showCookieBox;

function touchPracticeDay(){
  if(!getConsent())return;
  const k='hs_days';
  const d=(new Date()).toISOString().slice(0,10);
  const S=new Set(JSON.parse(localStorage.getItem(k)||'[]'));
  S.add(d);
  localStorage.setItem(k,JSON.stringify([...S]));
}
function getStreak(){
  const arr=JSON.parse(localStorage.getItem('hs_days')||'[]').sort();
  return{n:arr.length,last:arr[arr.length-1]||null}
}
function updateStreakUI(){
  const s=getStreak();
  $('streakCount').textContent=`Streak: ${s.n}`;
  const lang=$('lang').value;
  if(getConsent()){
    $('streakHint').textContent = s.last
      ? (lang==='en'?`Last: ${s.last}`:`L·∫ßn g·∫ßn nh·∫•t: ${s.last}`)
      : (lang==='en'?'No practice yet':'Ch∆∞a luy·ªán t·∫≠p');
  }else{
    $('streakHint').textContent = (lang==='en'
      ? 'Allow cookies to save streak.'
      : 'C·∫ßn cho ph√©p Cookie ƒë·ªÉ l∆∞u ng√†y luy·ªán t·∫≠p.');
  }
}
if(!localStorage.getItem('hs_consent')) showCookieBox();
updateStreakUI();

/* Learn grid */
function fillAlphaGrid(){
  const g=$('alphaGrid'); if(!g) return;
  g.innerHTML='';
  'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split('').forEach(ch=>{
    const e=document.createElement('div');
    e.className='cell';
    e.textContent=ch;
    e.onclick=()=>speak(ch,true);
    g.appendChild(e);
  });
}
fillAlphaGrid();

/* Speech / TTS */
let currentVolume=1.0, selectedVoice=null, allVoices=[];
function setVol(v){
  currentVolume=Math.max(0,Math.min(1,parseFloat(v)||1));
  $('vol').value=currentVolume;
  $('vol').style.setProperty('--p',(currentVolume*100)+'%');
  $('vol-val').textContent=Math.round(currentVolume*100)+'%';
}
$('vol').addEventListener('input',e=>setVol(e.target.value));
$('vol-dec').onclick=()=>setVol(currentVolume-0.1);
$('vol-inc').onclick=()=>setVol(currentVolume+0.1);

function speak(text,force){
  if(!force && !$('toggle-audio').checked) return;
  if(typeof window.speechSynthesis==='undefined' || typeof window.SpeechSynthesisUtterance==='undefined') return;
  try{
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    const lang=$('lang').value==='en'?'en-US':'vi-VN';
    u.lang=lang;
    if(selectedVoice) u.voice=selectedVoice;
    u.volume=currentVolume; u.rate=1; u.pitch=1;
    speechSynthesis.speak(u);
  }catch{}
}

function refreshVoices(){
  if(typeof window.speechSynthesis==='undefined') return;
  allVoices=speechSynthesis.getVoices()||[];
  const lang=$('lang').value;
  let pool=[];
  if(lang==='vi'){
    pool=allVoices.filter(v=>(v.lang||'').toLowerCase().startsWith('vi')||/(viet|vi·ªát|vietnam)/i.test(v.name||''));
  } else {
    pool=allVoices.filter(v=>(v.lang||'').toLowerCase().startsWith('en'));
  }
  if(pool.length===0) pool=allVoices.slice();
  pool.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  const sel=$('voiceSelect');
  sel.innerHTML='';
  pool.forEach(v=>{
    const o=document.createElement('option');
    o.value=v.name;
    o.textContent=v.name+' ‚Äî '+(v.lang||'');
    sel.appendChild(o);
  });
  selectedVoice=pool[0]||null;
  if(selectedVoice) sel.value=selectedVoice.name;
}
$('voiceSelect').onchange=e=>{
  selectedVoice=(allVoices||[]).find(v=>v.name===e.target.value)||null;
};
$('refreshVoice').onclick=refreshVoices;
if(typeof window.speechSynthesis!=='undefined'){
  speechSynthesis.onvoiceschanged=refreshVoices;
}

/* placeholders */
function refreshPlaceholders(){
  const lang=$('lang').value;
  $('tutorSeq').placeholder=(lang==='en'?'Enter a sequence (e.g., HELLO)':'Nh·∫≠p chu·ªói k√Ω t·ª± (v√≠ d·ª•: HELLO)');
  if(!$('ttsText').dataset.userEdited){
    $('ttsText').value=(lang==='en'?'Hello! This is a voice test.':'Xin ch√†o! ƒê√¢y l√† ki·ªÉm tra ti·∫øng n√≥i.');
  }
}
$('ttsText').addEventListener('input',()=>{$('ttsText').dataset.userEdited='1'});

/* language persistence */
(function initLang(){
  const saved=localStorage.getItem('hs_lang')||'vi';
  $('lang').value=saved;
  document.documentElement.lang=saved;
  applyI18N(saved);
})();
refreshPlaceholders();
refreshVoices();

$('lang').addEventListener('change',()=>{
  const L=$('lang').value;
  localStorage.setItem('hs_lang',L);
  document.documentElement.lang=L;
  applyI18N(L);
  refreshPlaceholders();
  refreshVoices();
  updateStreakUI();
  updateAuthStatus();
  if(progressCanvas) tracker.renderChart(progressCanvas,7);
});

/* Elements */
const videoEl=$('video'),canvasEl=$('canvas'),ghostEl=$('ghost'),bannerEl=$('banner'),captionEl=$('caption'),faceTag=$('faceTag');
function banner(t){if(bannerEl) bannerEl.textContent=t}
$('quickHelp').onclick=()=>{alert(I18N[$('lang').value].quick)};

/* Smoothing landmarks */
const smoothMap=new Map(); let lastTs=performance.now(); const SMOOTH_TAU_MS=90, BETA_MAX=0.65;
function emaLandmarks(key, lm){
  const now=performance.now(); const dt=Math.max(1, now-lastTs); lastTs=now;
  const beta=Math.min(BETA_MAX, 1-Math.exp(-dt/SMOOTH_TAU_MS));
  let s=smoothMap.get(key);
  if(!s){
    s=lm.map(p=>({x:p.x,y:p.y,z:p.z||0}));
    smoothMap.set(key,s); return s;
  }
  for(let i=0;i<lm.length;i++){
    const r=lm[i]; const t=s[i];
    t.x += (r.x - t.x)*beta;
    t.y += (r.y - t.y)*beta;
    t.z += ((r.z||0)-t.z)*beta;
  }
  return s;
}
function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y)}
function palmRef(lm){return dist(lm[0],lm[9])+1e-6}
function fingersUp(lm,handed){
  const tt=lm[4],ti=lm[3],i8=lm[8],i6=lm[6],m12=lm[12],m10=lm[10],r16=lm[16],r14=lm[14],p20=lm[20],p18=lm[18];
  const idx=i8.y<i6.y,mid=m12.y<m10.y,ring=r16.y<r14.y,pky=p20.y<p18.y;
  let th;
  if(handed==='Right')th=tt.x<ti.x;
  else if(handed==='Left')th=tt.x>ti.x;
  else th=tt.y<lm[2].y;
  return [th,idx,mid,ring,pky]
}
function isOK(lm){return dist(lm[4],lm[8])/palmRef(lm)<0.45}
function isOpenPalm(up){return up.filter(Boolean).length>=4}
function isThumbsUp(up,lm){return up[0]&&(up.slice(1).filter(Boolean).length<=1)&&(lm[4].y<lm[0].y)}
function isThumbsDown(up,lm){return up[0]&&(up.slice(1).filter(Boolean).length<=1)&&(lm[4].y>lm[0].y)}
function isFist(up,lm){
  if(up.filter(Boolean).length!==0)return false;
  const tips=[4,8,12,16,20].map(i=>dist(lm[i],lm[0])/palmRef(lm));
  const avg=tips.reduce((a,b)=>a+b,0)/tips.length;
  return avg<0.65
}
function isPoint(up){return up[1]&&!up[0]&&!up[2]&&!up[3]&&!up[4]}
function isVictory(up,lm){return (up[1]&&up[2]&&!up[3]&&!up[4])&&(dist(lm[8],lm[12])/palmRef(lm)>0.12)}

/* Wave */
const centroidHist=[]; const WAVE_HIST=16, WAVE_AMP_MIN=0.085, WAVE_SIGN_CHANGES_MIN=5, STOP_STABLE_AMP=0.02;
function updateMotion(lm){
  const cx=lm.reduce((a,p)=>a+p.x,0)/lm.length;
  centroidHist.push(cx);
  if(centroidHist.length>WAVE_HIST)centroidHist.shift();
}
function waveAmplitude(a){ if(a.length<2)return 0; return Math.max(...a)-Math.min(...a) }
function isWaving(){
  if(centroidHist.length<8)return false;
  const d=[];
  for(let i=1;i<centroidHist.length;i++)d.push(centroidHist[i]-centroidHist[i-1]);
  for(let i=0;i<d.length;i++)if(Math.abs(d[i])<0.004)d[i]=0;
  let c=0;
  for(let i=1;i<d.length;i++)if(Math.sign(d[i])!==Math.sign(d[i-1]))c++;
  return waveAmplitude(centroidHist)>=WAVE_AMP_MIN&&c>=WAVE_SIGN_CHANGES_MIN
}
function isStableOpenPalm(){return waveAmplitude(centroidHist)<STOP_STABLE_AMP}

/* Alphabet features */
const FEATURE_INDEXES=[0,5,9,13,17,1,2,3,4,8,12,16,20];
function lmToFeature(lm){
  const base=lm[0];
  const ref=palmRef(lm);
  const f=[];
  FEATURE_INDEXES.forEach(i=>{
    f.push((lm[i].x-base.x)/ref,(lm[i].y-base.y)/ref,(lm[i].z-base.z)/ref)
  });
  return f;
}
function cosine(a,b){
  let s=0,na=0,nb=0;
  for(let i=0;i<a.length;i++){
    s+=a[i]*b[i];na+=a[i]*a[i];nb+=b[i]*b[i]
  }
  return s/(Math.sqrt(na)*Math.sqrt(nb)+1e-8)
}
let ALPHA_DB=null;
function predictAlphaCosine(feat){
  if(!ALPHA_DB) return null;
  let best=null,score=-1;
  for(const lab in ALPHA_DB){
    const sims=ALPHA_DB[lab].map(v=>cosine(feat,v)).sort((a,b)=>b-a).slice(0,5);
    const sc=sims.reduce((a,b)=>a+b,0)/sims.length;
    if(sc>score){score=sc;best=lab}
  }
  return {label:best,score:score}
}
function feature60FromLandmarks(lm){
  const w=lm[0];
  const p=lm.map(v=>({x:v.x-w.x,y:v.y-w.y,z:(v.z||0)-(w.z||0)}));
  const a=Math.atan2(p[9].y,p[9].x),ca=Math.cos(-a),sa=Math.sin(-a);
  const r=p.map(v=>({x:v.x*ca - v.y*sa, y:v.x*sa + v.y*ca, z:v.z}));
  const pal=Math.hypot(r[5].x,r[5].y)+Math.hypot(r[17].x,r[17].y)+1e-6;
  const s=r.map(v=>({x:v.x/pal,y:v.y/pal,z:v.z/pal}));
  const out=new Float32Array(60);
  for(let i=1,j=0;i<21;i++){
    out[j++]=s[i].x;out[j++]=s[i].y;out[j++]=s[i].z;
  }
  return out
}
function L2(a,b){let d=0;for(let i=0;i<a.length;i++){const t=a[i]-b[i];d+=t*t}return Math.sqrt(d)}
let ALPHA60_DB=null;
function knnPredict(feat,k,DB){
  const arr=[];
  for(const lbl in DB){for(const v of (DB[lbl]||[])) arr.push([L2(feat,v),lbl])}
  if(arr.length===0) return null;
  arr.sort((a,b)=>a[0]-b[0]);
  const cut=arr.slice(0,Math.min(k,arr.length));
  const vote={};
  cut.forEach(([_,l])=>vote[l]=(vote[l]||0)+1);
  let best=null,bn=-1;
  for(const l in vote){if(vote[l]>bn){bn=vote[l];best=l}}
  return {label:best}
}

/* JSON load */
async function fileToText(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(String(r.result||''));
    r.onerror=rej;
    r.readAsText(file);
  })
}
function parseMaybeWrappedHSAlpha(txt){
  try{
    if(/HS_ALPHA\s*=/.test(txt)){
      const rhs=txt.replace(/^[^{]*=/,'').trim().replace(/;?\s*$/,'');
      return JSON.parse(rhs);
    }
    return JSON.parse(txt);
  }catch{return null}
}
function importCode2AlphabetJSON(txt){
  const js=JSON.parse(txt.trim().replace(/^var\s+\w+\s*=\s*/,'').replace(/;?\s*$/,''));
  const db={};
  for(const lab in js){
    db[lab]=js[lab].map(frame=>{
      let pts=[];
      if(Array.isArray(frame[0])) pts=frame.map(([x,y,z])=>({x,y,z}));
      else{
        for(let i=0;i<frame.length;i+=3){
          pts.push({x:frame[i],y:frame[i+1],z:frame[i+2]})
        }
      }
      return lmToFeature(pts)
    });
  }
  ALPHA_DB=db;
}
function toTriplets21(frame){
  if(!Array.isArray(frame))return null;
  if(frame.length===63 && typeof frame[0]==='number'){
    const t=[];
    for(let i=0;i<63;i+=3) t.push([frame[i],frame[i+1],frame[i+2]]);
    frame=t;
  }
  if(frame.length!==21)return null;
  const obj=frame.map(p=>Array.isArray(p)?{x:+p[0],y:+p[1],z:+p[2]}:(p&&typeof p==='object'?{x:+p.x,y:+p.y,z:+p.z}:null));
  return obj.every(o=>o&&isFinite(o.x)&&isFinite(o.y)&&isFinite(o.z))?obj:null
}
function importHSAlphaObject(obj){
  const raw=obj?.window?.HS_ALPHA ?? obj?.HS_ALPHA ?? obj;
  const db39={},db60={};
  for(const lbl in raw){
    const arr=raw[lbl]; if(!Array.isArray(arr)) continue;
    for(const sample of arr){
      const lm=toTriplets21(sample);
      if(!lm) continue;
      (db39[lbl]||(db39[lbl]=[])).push(lmToFeature(lm));
      (db60[lbl]||(db60[lbl]=[])).push(feature60FromLandmarks(lm));
    }
  }
  if(Object.keys(db39).length) ALPHA_DB=db39;
  if(Object.keys(db60).length) ALPHA60_DB=db60;
}
function importFeature60JSON(txt){
  const j=JSON.parse(txt);
  const db60={};
  for(const k in j){
    if(Array.isArray(j[k])) db60[k]=j[k].map(a=>Float32Array.from(a));
  }
  ALPHA60_DB=db60;
}
$('alphaLoad').onclick=async()=>{
  const t=I18N[$('lang').value];
  const f=$('alphaFile').files?.[0];
  if(!f){banner(t.select_json_first);return}
  try{
    const txt=await fileToText(f);
    const obj=parseMaybeWrappedHSAlpha(txt);
    ALPHA_DB=null;ALPHA60_DB=null;

    try{
      if(obj) importHSAlphaObject(obj);
      if(!ALPHA_DB && !ALPHA60_DB) importCode2AlphabetJSON(txt);
    }catch{
      try{ importFeature60JSON(txt); }catch{}
    }

    const have39=!!ALPHA_DB && Object.keys(ALPHA_DB).length;
    const have60=!!ALPHA60_DB && Object.keys(ALPHA60_DB).length;
    if(have39||have60){
      $('alphaInfo').textContent=(have39&&have60)?'Loaded (39d+60d)':(have39?'Loaded (39d)':'Loaded (60d)');
      banner(t.loaded_db+': '+(have39&&have60?'39d+60d':have39?'39d':'60d'));
    } else {
      $('alphaInfo').textContent='No DB';
      banner(t.invalid_json);
    }
  }catch(e){
    console.error(e);
    banner(I18N[$('lang').value].invalid_json);
  }
};
$('alphaClear').onclick=()=>{
  ALPHA_DB=null;ALPHA60_DB=null;
  $('alphaInfo').textContent='Ch∆∞a n·∫°p DB';
  banner(I18N[$('lang').value].db_cleared);
};

/* ==== GHOST TUTOR (CROP FULL SIGN + LETTER/NUMBER) ==== */
const CHART_URL=document.getElementById('chartImg').src;
let chartImg=new Image();
chartImg.crossOrigin='anonymous';
chartImg.src=CHART_URL;

let tutorRunning=false;
let tutorCurrent=null;

const SIGN_POS = {
  A:[0,0],B:[0,1],C:[0,2],D:[0,3],E:[0,4],
  F:[1,0],G:[1,1],H:[1,2],I:[1,3],J:[1,4],
  K:[2,0],L:[2,1],M:[2,2],N:[2,3],O:[2,4],
  P:[3,0],Q:[3,1],R:[3,2],S:[3,3],T:[3,4],
  U:[4,0],V:[4,1],W:[4,2],X:[4,3],Y:[4,4],
  Z:[5,0], "0":[5,1], "1":[5,2], "2":[5,3], "3":[5,4],
  "4":[6,0], "5":[6,1], "6":[6,2], "7":[6,3], "8":[6,4], "9":[6,5],
};
const ROW_COLS = [5,5,5,5,5,5,6];
const ROW_BANDS = [
  { y0: 0,    y1: 283,  x0: 49,  x1: 1272 },
  { y0: 288,  y1: 562,  x0: 68,  x1: 1291 },
  { y0: 574,  y1: 852,  x0: 53,  x1: 1287 },
  { y0: 857,  y1: 1128, x0: 66,  x1: 1285 },
  { y0: 1141, y1: 1414, x0: 60,  x1: 1292 },
  { y0: 1433, y1: 1679, x0: 91,  x1: 1249 },
  { y0: 1738, y1: 2047, x0: 69,  x1: 1331 },
];

function clearGhost(){
  const ctx=ghostEl.getContext('2d');
  ctx.clearRect(0,0,ghostEl.width=canvasEl.width,ghostEl.height=canvasEl.height);
}
function drawGhostFromChart(ch){
  const ctx=ghostEl.getContext('2d');
  const W=ghostEl.width=canvasEl.width;
  const H=ghostEl.height=canvasEl.height;
  ctx.clearRect(0,0,W,H);

  if(!$('ghostToggle').checked) return;
  if(!tutorRunning) return;
  if(!chartImg.complete || !chartImg.naturalWidth) return;

  const key=String(ch||'').toUpperCase();
  if(!(key in SIGN_POS)) return;

  const [row,col]=SIGN_POS[key];
  const band=ROW_BANDS[row];
  const cols=ROW_COLS[row];

  const bw=(band.x1-band.x0);
  const bh=(band.y1-band.y0);
  const cw=bw/cols;

  const insetX = cw * 0.03;
  const insetYTop = bh * 0.04;
  const extraBottom = bh * 0.22;

  const sx = Math.floor(band.x0 + col*cw + insetX);
  const sy = Math.floor(band.y0 + insetYTop);
  const sw = Math.floor(cw - insetX*2);

  let sh = Math.floor((band.y1 - sy) + extraBottom);
  sh = Math.min(sh, chartImg.naturalHeight - sy);

  const pad = Math.min(W,H)*0.06;
  const boxW = W*0.52, boxH = H*0.52;
  const dx = W - pad - boxW, dy = pad;

  ctx.save();
  ctx.globalAlpha=0.95;
  ctx.drawImage(chartImg, sx, sy, sw, sh, dx, dy, boxW, boxH);
  ctx.restore();
}

$('tutorStart').onclick=()=>{
  const s=($('tutorSeq').value||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(!s){alert(I18N[$('lang').value].enter_seq);return}
  tutorRunning=true;
  const lang=$('lang').value;
  let i=0;
  (function step(){
    if(i>=s.length){
      tutorRunning=false;
      tutorCurrent=null;
      clearGhost();
      return;
    }
    const ch=s[i];
    tutorCurrent=ch;
    const prompt=I18N[lang].tutor_prompt(ch);
    $('caption').textContent=prompt;
    speak(prompt,true);
    drawGhostFromChart(ch);
    i++;
    setTimeout(step,2200);
  })()
};
$('ghostToggle').addEventListener('change',()=>{
  if(!$('ghostToggle').checked) clearGhost();
  else if(tutorRunning) drawGhostFromChart(tutorCurrent);
});

/* Mode logic */
function getMode(){return ($('mode')?.value)||'actions'}
function allowAlphabetDetect(){
  const hasDb = !!ALPHA_DB || !!ALPHA60_DB;
  const m=getMode();
  return hasDb && (m==='alphabet' || m==='auto');
}
function allowActions(){return getMode()!=='alphabet'}

/* Face mesh status */
function onFace(r){
  if(!r.multiFaceLandmarks||!r.multiFaceLandmarks.length){faceTag.textContent='üôÇ';return}
  const l=r.multiFaceLandmarks[0];
  const L=l[61],R=l[291],T=l[13],B=l[14];
  const w=Math.hypot(L.x-R.x,L.y-R.y), h=Math.hypot(T.x-B.x,T.y-B.y)+1e-6;
  const s=w/h;
  faceTag.textContent=(s>2.0? 'üòä' : 'üôÇ')
}

/* Log */
const liveLog=$('liveLog');
function logLine(s){
  if(!liveLog) return;
  const p=document.createElement('div');
  p.textContent=s;
  liveLog.appendChild(p);
  liveLog.scrollTop=liveLog.scrollHeight;
}

/* ==== PROGRESS TRACKER ==== */
class ProgressTracker{
  constructor({storageKey="hs_progress",userId=null}={}){
    this.storageKey=storageKey;
    this.userId=userId;
    this.sessions=this._loadLocal();
  }
  setUser(id){this.userId=id;}
  logSession({gestureType,label,success,durationMs}){
    const rec={
      userId:this.userId||"_guest",
      gestureType,label,
      success:!!success,
      durationMs:durationMs||0,
      ts:Date.now()
    };
    this.sessions.push(rec);
    this._saveLocal();
  }
  getDailyStats(days=7){
    const now=new Date();const map={};
    for(let i=days-1;i>=0;i--){
      const d=new Date(now);
      d.setDate(now.getDate()-i);
      const key=d.toISOString().slice(0,10);
      map[key]={count:0,success:0};
    }
    for(const s of this.sessions){
      const key=new Date(s.ts).toISOString().slice(0,10);
      if(!map[key])continue;
      map[key].count++;
      if(s.success)map[key].success++;
    }
    const labels=[],counts=[],successRates=[];
    for(const [date,info] of Object.entries(map)){
      labels.push(date.slice(5));
      counts.push(info.count);
      successRates.push(info.count?info.success/info.count:0);
    }
    return{labels,counts,successRates};
  }
  renderChart(canvas,days=7){
    if(!canvas)return;
    const ctx=canvas.getContext("2d");
    const {labels,counts,successRates}=this.getDailyStats(days);
    const w=canvas.width,h=canvas.height;
    ctx.clearRect(0,0,w,h);

    ctx.fillStyle="#e5e7eb";
    ctx.font="11px system-ui";
    ctx.strokeStyle="#4b5563";
    ctx.lineWidth=1;
    ctx.strokeRect(40,18,w-60,h-52);

    const maxCount=Math.max(1,...counts);
    const gx=(w-60)/Math.max(1,labels.length-1);
    const gy=(h-56)/maxCount;

    ctx.beginPath();
    ctx.strokeStyle="#22c55e";
    ctx.lineWidth=2;
    counts.forEach((c,i)=>{
      const x=40+i*gx,y=h-40-c*gy;
      if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.fillStyle="#22c55e";
    counts.forEach((c,i)=>{
      const x=40+i*gx,y=h-40-c*gy;
      ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);ctx.fill();
    });

    ctx.fillStyle="#9ca3af";
    labels.forEach((lb,i)=>{
      const x=40+i*gx-10;ctx.fillText(lb,x,h-24);
    });

    successRates.forEach((r,i)=>{
      const barH=20*r,x=40+i*gx-3,y=20+(20-barH);
      ctx.fillStyle="#6b7280";
      ctx.fillRect(x,y,6,barH);
    });

    ctx.fillStyle="#22c55e";ctx.fillText("Count",50,14);
    ctx.fillStyle="#9ca3af";ctx.fillText("Accuracy",110,14);
  }
  _loadLocal(){
    if(typeof localStorage==="undefined")return[];
    try{
      const raw=localStorage.getItem(this.storageKey);
      return raw?JSON.parse(raw):[];
    }catch{return[];}
  }
  _saveLocal(){
    if(typeof localStorage==="undefined")return;
    try{
      localStorage.setItem(this.storageKey,JSON.stringify(this.sessions));
    }catch{}
  }
}
const progressCanvas=$('progressChart');
const tracker=new ProgressTracker({storageKey:"hs_progress",userId:null});
if(progressCanvas) tracker.renderChart(progressCanvas,7);

/* ==== AUTH DEMO ==== */
let currentUser=null;
let guestMode=false;
function loadAuth(){ try{const raw=localStorage.getItem("hs_auth"); return raw?JSON.parse(raw):null;}catch{return null;} }
function saveAuth(u){ try{localStorage.setItem("hs_auth",JSON.stringify(u));}catch{} }
function clearAuth(){ try{localStorage.removeItem("hs_auth");}catch{} }
function isValidPassword(pw){ return pw.length>=6 && /[A-Za-z]/.test(pw) && /[0-9]/.test(pw) && /@/.test(pw); }

function setTopBadge(mode,user){
  const badge=$('authTopBadge');
  const lang=$('lang').value;
  if(mode==="user" && user){
    badge.style.display='flex';
    $('authTopText').textContent=(lang==='en'?'Hi, ':'Xin ch√†o, ')+(user.displayName||user.email);
  }else if(mode==="guest"){
    badge.style.display='flex';
    $('authTopText').textContent=(lang==='en'?'Guest mode':'Ch·∫ø ƒë·ªô kh√°ch');
  }else{
    badge.style.display='none';
  }
}
function updateAuthStatus(){
  const s=$('authStatus');
  const u=currentUser;
  const lang=$('lang').value;
  if(u){
    s.innerHTML=(lang==='en'?`Signed in: <b>${u.displayName||u.email}</b>`:`ƒê√£ ƒëƒÉng nh·∫≠p: <b>${u.displayName||u.email}</b>`);
    guestMode=false;
    tracker.setUser(u.id);
    setTopBadge("user",u);
  }else if(guestMode){
    s.textContent=(lang==='en'?'Using Guest mode (no sign-in required).':'ƒêang s·ª≠ d·ª•ng ·ªü ch·∫ø ƒë·ªô Kh√°ch (kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p).');
    tracker.setUser("_guest");
    setTopBadge("guest");
  }else{
    s.textContent=(lang==='en'?'Not signed in ‚Äî you can use Guest mode.':'Ch∆∞a ƒëƒÉng nh·∫≠p ‚Äì b·∫°n c√≥ th·ªÉ d√πng ch·∫ø ƒë·ªô Kh√°ch.');
    tracker.setUser(null);
    setTopBadge("none");
  }
  tracker.renderChart(progressCanvas,7);
}
currentUser=loadAuth();
if(currentUser){guestMode=false;}
updateAuthStatus();

$('togglePass').onclick=()=>{
  const inp=$('authPass');
  const isPw=inp.type==="password";
  inp.type=isPw?"text":"password";
  $('togglePass').textContent=isPw?"üôà":"üëÅ";
};
$('btnRegister').onclick=()=>{
  const email=$('authEmail').value.trim();
  const name=$('authName').value.trim();
  const pass=$('authPass').value;
  const lang=$('lang').value;
  if(!email){alert(lang==='en'?'Please enter Gmail.':'Vui l√≤ng nh·∫≠p Gmail.');return;}
  if(!isValidPassword(pass)){
    alert(lang==='en'
      ? "Password must be 6+ chars and include letters, digits, and @ (e.g., Hs@2025)."
      : "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±, ch·ª©a ch·ªØ c√°i, s·ªë v√† k√Ω t·ª± @ (v√≠ d·ª•: Hs@2025).");
    return;
  }
  const u={id:email,email,displayName:name||email};
  currentUser=u; saveAuth(u); guestMode=false; updateAuthStatus();
  logLine((lang==='en'?'Registered: ':'ƒêƒÉng k√Ω: ')+u.email);
};
$('btnLogin').onclick=()=>{
  const email=$('authEmail').value.trim();
  const lang=$('lang').value;
  if(!email){alert(lang==='en'?'Please enter Gmail.':'Vui l√≤ng nh·∫≠p Gmail.');return;}
  const u=loadAuth();
  if(u && u.email===email){
    currentUser=u; guestMode=false; updateAuthStatus();
    logLine((lang==='en'?'Logged in: ':'ƒêƒÉng nh·∫≠p: ')+u.email);
  }else{
    alert(lang==='en'
      ? "Account not found (local demo). Please register first."
      : "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n (demo local). B·∫°n h√£y ƒêƒÉng k√Ω tr∆∞·ªõc.");
  }
};
$('btnGuest').onclick=()=>{
  currentUser=null; guestMode=true; updateAuthStatus();
  logLine($('lang').value==='en'?'Guest mode.':'Ch·∫ø ƒë·ªô kh√°ch.');
};
$('authTopLogout').onclick=()=>{
  currentUser=null; guestMode=false; clearAuth(); updateAuthStatus();
  logLine($('lang').value==='en'?'Logged out.':'ƒê√£ ƒëƒÉng xu·∫•t.');
};
$('btnLoginFacebook').onclick=()=>alert($('lang').value==='en'?'Demo: Facebook login needs backend (OAuth).':'Demo: ƒêƒÉng nh·∫≠p Facebook c·∫ßn backend (OAuth).');
$('btnLoginPhone').onclick=()=>alert($('lang').value==='en'?'Demo: Phone OTP needs server.':'Demo: ƒêƒÉng nh·∫≠p b·∫±ng s·ªë ƒëi·ªán tho·∫°i + OTP c·∫ßn server.');
$('btnLoginApple').onclick=()=>alert($('lang').value==='en'?'Demo: Apple ID needs OAuth2.':'Demo: ƒêƒÉng nh·∫≠p b·∫±ng Apple ID c·∫ßn OAuth2.');

/* === GI·ªÆ TAY 1.2s ‚Üí PH√ÅT √ÇM 1 L·∫¶N (‚úÖ y√™u c·∫ßu 1‚Äì1.5s) === */
let holdLabel=null, holdType=null, holdSince=0, holdSpoken=false;
const MIN_HOLD_MS=1200; // ‚úÖ 1.2 gi√¢y
function handleSpeaking(chosen){
  const now=performance.now();
  if(chosen){
    if(chosen.label!==holdLabel || chosen.type!==holdType){
      holdLabel=chosen.label; holdType=chosen.type;
      holdSince=now; holdSpoken=false;
    }else{
      if(!holdSpoken && now-holdSince>=MIN_HOLD_MS){
        speak(chosen.text,true);
        holdSpoken=true;
        touchPracticeDay(); updateStreakUI();
        captionEl.textContent=chosen.text;
        logLine(`[${new Date().toLocaleTimeString()}] ${chosen.type}: ${chosen.label} (${((now-holdSince)/1000).toFixed(1)}s)`);
        tracker.logSession({gestureType:chosen.type,label:chosen.label,success:true,durationMs:now-holdSince});
        tracker.renderChart(progressCanvas,7);
      }
    }
  }else{
    holdLabel=null; holdType=null; holdSince=0; holdSpoken=false;
  }
}

/* Stable history */
const ACTION_HIST_LEN=8, ALPHA_HIST_LEN=8, ACTION_MIN_STABLE=5, ALPHA_MIN_STABLE=5;
let actionHist=[], alphaHist=[];
function pushHist(hist,label,maxLen){hist.push(label||null); if(hist.length>maxLen) hist.shift();}
function isStable(hist,label,minCount){
  if(!label) return false;
  let count=0;
  for(let i=hist.length-1;i>=0 && count<minCount;i--){
    if(hist[i]===label) count++;
  }
  return count>=minCount;
}

/* MediaPipe */
let handsInst=null, faceMeshInst=null, cam=null, stream=null;

function onHands(results){
  const img=results.image;
  const W=canvasEl.width=img.width, H=canvasEl.height=img.height;
  const ctx=canvasEl.getContext('2d');
  ctx.clearRect(0,0,W,H);
  ctx.drawImage(img,0,0,W,H);

  const handsLM=results.multiHandLandmarks||[];
  const handness=results.multiHandedness||[];
  const detHands=[];

  let bestAction=null;
  let bestAlpha=null;

  for(let i=0;i<handsLM.length;i++){
    const raw=handsLM[i];
    const handed=(handness[i]&&handness[i].label)||`H${i}`;
    const key=`${handed}_${i}`;
    const lm=emaLandmarks(key, raw);
    detHands.push({lm,handed});

    if(typeof drawConnectors==='function' && typeof HAND_CONNECTIONS!=='undefined'){
      drawConnectors(ctx,lm,HAND_CONNECTIONS,{color:'#00FF88',lineWidth:3});
    }
    if(typeof drawLandmarks==='function'){
      drawLandmarks(ctx,lm,{color:'#FFFFFF',lineWidth:1});
    }
    updateMotion(lm);

    const lang=$('lang').value;

    if(allowActions()){
      const up=fingersUp(lm,handed);
      let label=null;
      if(isOK(lm))label="OK";
      else if(isOpenPalm(up)&&isWaving())label="WAVE";
      else if(isOpenPalm(up)&&isStableOpenPalm())label="STOP";
      else if(isThumbsUp(up,lm))label="THUMBS_UP";
      else if(isThumbsDown(up,lm))label="THUMBS_DOWN";
      else if(isOpenPalm(up))label="OPEN_PALM";
      else if(isVictory(up,lm))label="VICTORY";
      else if(isFist(up,lm))label="FIST";
      else if(isPoint(up))label="POINT";

      if(label && !bestAction){
        const phrase=I18N[lang].phrases[label]||label;
        bestAction={type:'ACTION',label,text:phrase};
      }
    }

    if(allowAlphabetDetect()){
      let pred=null;
      if(ALPHA_DB){
        const feat39=lmToFeature(lm);
        const r=predictAlphaCosine(feat39);
        if(r&&r.label) pred=r.label;
      }else if(ALPHA60_DB){
        const feat60=feature60FromLandmarks(lm);
        const r=knnPredict(feat60,3,ALPHA60_DB);
        if(r&&r.label) pred=r.label;
      }
      if(pred && !bestAlpha){
        bestAlpha={type:'ALPHABET',label:pred,text:pred};
        $('alphaPred').textContent=pred;
      }
    }
  }

  // 2-hand THANKS
  if(allowActions() && detHands.length>=2){
    let fired=false;
    for(let a=0;a<detHands.length && !fired;a++){
      for(let b=a+1;b<detHands.length && !fired;b++){
        const L=detHands[a].lm, R=detHands[b].lm;
        const ref=(palmRef(L)+palmRef(R))/2;
        const palmDist=dist(L[0],R[0]);
        const idxIdx=dist(L[8],R[8]);
        const upL=fingersUp(L,'Unknown'), upR=fingersUp(R,'Unknown');
        const bothOpen=upL.filter(Boolean).length>=4 && upR.filter(Boolean).length>=4;
        const farEnough=palmDist>0.20*ref && idxIdx>0.16*ref;
        if(bothOpen && farEnough){
          const phrase=I18N[$('lang').value].phrases.THANKS;
          bestAction={type:'ACTION',label:'THANKS',text:phrase};
          fired=true;
        }
      }
    }
  }

  pushHist(actionHist,bestAction && bestAction.label,ACTION_HIST_LEN);
  pushHist(alphaHist, bestAlpha  && bestAlpha.label, ALPHA_HIST_LEN);

  if(bestAction && !isStable(actionHist,bestAction.label,ACTION_MIN_STABLE)) bestAction=null;
  if(bestAlpha  && !isStable(alphaHist, bestAlpha.label, ALPHA_MIN_STABLE)) bestAlpha=null;

  const mode=getMode();
  let chosen=null;
  if(mode==='actions') chosen=bestAction;
  else if(mode==='alphabet') chosen=bestAlpha;
  else chosen=bestAction || bestAlpha;

  captionEl.textContent=chosen?chosen.text:'‚Ä¶';
  handleSpeaking(chosen);
}

async function startCamera(){
  const t=I18N[$('lang').value];
  try{
    if(!navigator.mediaDevices?.getUserMedia){banner(t.browser_not_supported);return}
    banner(t.requesting_camera);
    const ps=$('powerSave').checked;
    const W=ps?640:848, H=ps?360:480;

    stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:W},height:{ideal:H},facingMode:'user'},audio:false});
    videoEl.srcObject=stream;

    if(typeof Hands==='undefined' || typeof FaceMesh==='undefined' || typeof Camera==='undefined'){
      banner(t.mediapipe_not_loaded);
      return;
    }

    handsInst=new Hands({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
    handsInst.setOptions({
      maxNumHands:2,
      modelComplexity:0,
      minDetectionConfidence:ps?0.7:0.75,
      minTrackingConfidence:ps?0.6:0.7
    });
    handsInst.onResults(onHands);

    faceMeshInst=new FaceMesh({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    faceMeshInst.setOptions({
      maxNumFaces:1,
      refineLandmarks:false,
      minDetectionConfidence:ps?0.55:0.6,
      minTrackingConfidence:ps?0.55:0.6
    });
    faceMeshInst.onResults(onFace);

    cam=new Camera(videoEl,{
      onFrame:async()=>{
        if(!handsInst || !faceMeshInst) return;
        await handsInst.send({image:videoEl});
        await faceMeshInst.send({image:videoEl});
      },
      width:W,height:H
    });
    await cam.start();

    banner(t.ready_hand);
    touchPracticeDay();updateStreakUI();
  }catch(e){
    console.error(e);
    banner((($('lang').value==='en'?'Error: ':'L·ªói: '))+(e?.name||'unknown'));
  }
}

function stopCamera(){
  try{
    if(cam&&cam.stop)cam.stop();
    if(stream)stream.getTracks().forEach(t=>t.stop());
    videoEl.srcObject=null;
    banner(I18N[$('lang').value].camera_stopped);
  }catch{}
}

$('startCam').onclick=startCamera;
$('stopCam').onclick=stopCamera;
$('flipCam').onclick=()=>{document.getElementById('stage').classList.toggle('mirror')};

/* Recorder */
let rec=null, recChunks=[], recMime='';
function pickMime(){
  const c=['video/webm;codecs=vp9','video/webm;codecs=vp8','video/webm'];
  for(const k of c){ if(window.MediaRecorder&&MediaRecorder.isTypeSupported(k))return k }
  return''
}
$('recStart').onclick=()=>{try{
  const s=canvasEl.captureStream(30);
  recMime=pickMime();
  rec=new MediaRecorder(s,recMime?{mimeType:recMime}:undefined);
  rec.ondataavailable=e=>{if(e.data&&e.data.size)recChunks.push(e.data)};
  rec.onstop=()=>{
    const blob=new Blob(recChunks,{type:recMime||'video/webm'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='handspeak_recording.webm'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),2e4);
    recChunks=[];
  };
  rec.start(); banner($('lang').value==='en'?'Recording‚Ä¶':'ƒêang ghi h√¨nh‚Ä¶');
}catch(e){banner($('lang').value==='en'?'Recording not supported':'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ghi h√¨nh')}}; 
$('recStop').onclick=()=>{try{if(rec&&rec.state!=='inactive'){rec.stop(); banner($('lang').value==='en'?'Saved video':'ƒê√£ l∆∞u video')}}catch{}};

/* Hero */
const title = document.getElementById('heroTitle');
const sub = document.getElementById('heroSubtitle');
if (title && sub){
  title.textContent = 'HandSpeak AI';
  sub.textContent = 'Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi HandSpeak - ·ª®ng d·ª•ng k·∫øt n·ªëi c·ªông ƒë·ªìng.';
  sub.classList.add('hero-sub-show');
  setTimeout(() => {
    sub.classList.remove('hero-sub-show');
    sub.classList.add('hero-sub-fade');
    setTimeout(() => {
      sub.classList.remove('hero-sub-fade');
      sub.textContent = 'K√Ω hi·ªáu - K·∫øt n·ªëi - Y√™u th∆∞∆°ng';
      sub.classList.add('hero-sub-show');
    }, 420);
  }, 2300);
}

/* TTS demo */
$('sayNow').onclick=()=>{speak($('ttsText').value,true)};
$('stopSay').onclick=()=>{if(typeof window.speechSynthesis!=='undefined') speechSynthesis.cancel()};

}); // DOMContentLoaded
</script>
</body>
</html>
